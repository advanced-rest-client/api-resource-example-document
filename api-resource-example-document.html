<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/utils/render-status.html">
<link rel="import" href="../clipboard-copy/clipboard-copy.html">
<link rel="import" href="../arc-icons/arc-icons.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../json-table/json-table.html">
<link rel="import" href="../prism-element/prism-highlighter.html">
<link rel="import" href="../amf-helper-mixin/amf-helper-mixin.html">
<link rel="import" href="../api-example-generator/api-example-generator.html">
<link rel="import" href="api-example-render.html">
<dom-module id="api-resource-example-document">
  <template>
    <style>
    :host {
      display: block;
      @apply --api-resource-example-document;
    }

    [hidden] {
      display: none !important;
    }

    h6 {
      @apply --arc-font-body1;
      font-size: 15px;
      margin: 0 0 4px 4px;
      @apply --api-resource-example-document-title;
    }

    paper-icon-button[active] {
      background-color: var(--api-resource-example-document-button-active-background-color, #e0e0e0);
      border-radius: 50%;
    }

    .example:not(:last-of-type) {
      margin-bottom: 24px;
    }
    </style>
    <prism-highlighter></prism-highlighter>
    <template is="dom-if" if="[[hasExamples]]">
      <template is="dom-repeat" items="[[renderedExamples]]">
        <div class="example">
          <template is="dom-if" if="[[item.hasTitle]]">
            <h6>[[item.title]]</h6>
          </template>
          <div class="example-actions">
            <paper-icon-button icon="arc:content-copy" data-action="copy" on-click="_copyToClipboard" title="Copy example to clipboard"></paper-icon-button>
            <template is="dom-if" if="[[isJson]]">
              <paper-icon-button icon="arc:view-column" data-action="table" active="[[table]]" title="Toggle table view" toggles on-click="toggleTable"></paper-icon-button>
            </template>
          </div>
          <template is="dom-if" if="[[!_effectiveTable]]" restamp>
            <api-example-render code="[[item.value]]" media-type="[[mediaType]]"></api-example-render>
          </template>
          <template is="dom-if" if="[[_effectiveTable]]" restamp>
            <json-table json="[[item.value]]"></json-table>
          </template>
        </div>
      </template>
    </template>
    <clipboard-copy></clipboard-copy>
    <api-example-generator amf-model="[[amfModel]]" id="exampleGenerator"></api-example-generator>
  </template>
  <script>
  /**
   * `api-resource-example-document`
   *
   * Renders list of examples defined in AMF model. It renders values that
   * are structured examples (JSON, RAML type).
   *
   * ## Example
   * ```html
   * <api-resource-example-document examples="[...]"></api-resource-example-document>
   * ```
   *
   * ## Styling
   *
   * `<api-resource-example-document>` provides the following custom properties and mixins for styling:
   *
   * Custom property | Description | Default
   * ----------------|-------------|----------
   * `--api-resource-example-document` | Mixin applied to this elment | `{}`
   * `--api-resource-example-document-title` | Mixin applied to example title | `{}`
   * `--api-resource-example-document-button-active-background-color` | Background color of active "tabble" button | `#e0e0e0`
   *
   * @customElement
   * @polymer
   * @demo demo/index.html
   * @memberof ApiElements
   * @appliesMixin ApiElements.AmfHelperMixin
   */
  class ApiResourceExampleDocument extends ApiElements.AmfHelperMixin(Polymer.Element) {
    static get is() {
      return 'api-resource-example-document';
    }
    static get properties() {
      return {
        /**
         * AMF model for examples.
         */
        examples: Array,
        /**
         * Examples media type
         */
        mediaType: String,
        /**
         * Type (model) name for which examples are generated for.
         * This is used by RAML to XML examples processor to wrap the example
         * in type name. If missing this wrapping is omnited.
         */
        typeName: String,
        /**
         * Computed in a debouncer examples to render.
         */
        renderedExamples: {
          type: Array,
          readOnly: true
        },
        /**
         * Computed value, true if there's any example to render.
         */
        hasExamples: {
          type: Boolean,
          computed: '_computeHasArrayValue(renderedExamples)'
        },
        /**
         * If true it will display a table view instead of JSON code.
         * `isJson` must be set to use this option.
         */
        table: {
          type: Boolean,
          value: false,
          observer: '_tableChanged'
        },
        /**
         * Computed value, true if selected media type is application/json
         * or equivalent.
         */
        isJson: {
          type: Boolean,
          computed: '_computeIsJson(mediaType)'
        },

        _effectiveTable: {
          type: Boolean,
          computed: '_computeEffectiveTable(table, isJson)'
        }
      };
    }

    static get observers() {
      return ['_computeExamples(examples, mediaType, typeName)'];
    }

    constructor() {
      super();
      this._onStorageChanged = this._onStorageChanged.bind(this);
      this._onJsonTableStateChanged = this._onJsonTableStateChanged.bind(this);
    }

    connectedCallback() {
      super.connectedCallback();
      window.addEventListener('storage', this._onStorageChanged);
      window.addEventListener('json-table-state-changed', this._onJsonTableStateChanged);
    }

    disconnectedCallback() {
      super.disconnectedCallback();
      window.removeEventListener('storage', this._onStorageChanged);
      window.removeEventListener('json-table-state-changed', this._onJsonTableStateChanged);
    }

    _computeTitle(item) {
      let value = this._getValue(item, this.ns.schema.schemaName);
      if (value && (value === 'schema' || value.indexOf('example_') === 0)) {
        return;
      }
      return value;
    }

    /**
     * Coppies current response text value to clipboard.
     *
     * @param {Event} e
     */
    _copyToClipboard(e) {
      const button = this.shadowRoot.querySelector('[data-action="copy"]');
      const copy = this.shadowRoot.querySelector('clipboard-copy');
      const example = this.renderedExamples[e.model.get('index')];
      copy.content = example.value;
      if (copy.copy()) {
        button.icon = 'arc:done';
      } else {
        button.icon = 'arc:error';
      }
      setTimeout(() => this._resetCopyButtonState(button), 1000);
    }

    _resetCopyButtonState(button) {
      button.icon = 'arc:content-copy';
    }
    // Toggles the JSON table view
    toggleTable() {
      this.table = !this.table;
    }

    // Handler to the `table` change, fires corresponding event and sets local storage.
    _tableChanged(state) {
      if (state === undefined) {
        return;
      }
      if (localStorage.jsonTableEnabled !== String(state)) {
        window.localStorage.setItem('jsonTableEnabled', state);
      }
      this.dispatchEvent(new CustomEvent('json-table-state-changed', {
        bubbles: true,
        detail: {
          enabled: state
        }
      }));
    }
    /**
     * Updates the value of the `isJsonTable` property when the corresponding localStorage
     * property change.
     */
    _onStorageChanged(e) {
      if (e.key !== 'jsonTableEnabled') {
        return;
      }
      if (!e.newValue) {
        return;
      }
      const v = this._localStorageValueToBoolean(e.newValue);
      if (this.table !== v) {
        this.table = v;
      }
    }
    /**
     * Reads the local value (always a string) as a boolean value.
     *
     * @param {String} value The value read from the local storage.
     * @return {Boolean} Boolean value read from the value.
     */
    _localStorageValueToBoolean(value) {
      if (!value) {
        return false;
      }
      if (value === 'true') {
        value = true;
      } else {
        value = false;
      }
      return value;
    }
    /**
     * Handler to the incomming `json-table-state-changed` event.
     * Sets the `table` property if it is different.
     */
    _onJsonTableStateChanged(e) {
      if (e.target === this) {
        return;
      }
      const enabled = e.detail.enabled;
      if (enabled !== this.table) {
        this.table = enabled;
      }
    }

    _computeExamples() {
      if (this._examplesDebouncer) {
        return;
      }
      this._examplesDebouncer = true;
      Polymer.RenderStatus.afterNextRender(this, () => {
        this._examplesDebouncer = false;
        this.__computeExamples(this.examples, this.mediaType, this.typeName);
      });
    }

    __computeExamples(examples, mediaType, typeName) {
      this._setRenderedExamples(undefined);
      if (!examples || !examples.length || !mediaType) {
        return;
      }
      const opts = {
        typeName
      };
      const result = [];
      for (let i = 0, len = examples.length; i < len; i++) {
        const example = examples[i];
        const value = this.$.exampleGenerator.computeExample(mediaType, example, opts);
        if (value) {
          const title = this._computeTitle(example);
          result[result.length] = {
            value,
            title,
            hasTitle: !!title
          };
        }
      }
      if (result.length) {
        this._setRenderedExamples(result);
      }
    }

    _computeIsJson(type) {
      return !!(type && type.indexOf('json') !== -1);
    }

    _computeEffectiveTable(table, isJson) {
      return !!(isJson && table);
    }
  }
  window.customElements.define(ApiResourceExampleDocument.is, ApiResourceExampleDocument);
  </script>
</dom-module>
