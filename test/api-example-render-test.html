<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">
  <title>api-example-render test</title>
  <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <link rel="import" href="../../arc-polyfills/arc-polyfills.html">
  <link rel="import" href="../../prism-element/prism-highlighter.html">
  <script src="../../iron-test-helpers/mock-interactions.js"></script>
  <script src="amf-loader.js"></script>
  <link rel="import" href="../api-example-render.html">
</head>
<body>
  <test-fixture id="Basic">
    <template>
      <api-example-render></api-example-render>
    </template>
  </test-fixture>

  <test-fixture id="Json">
    <template>
      <api-example-render media-type="application/json" is-json></api-example-render>
    </template>
  </test-fixture>

  <test-fixture id="NoActions">
    <template>
      <api-example-render media-type="application/json" is-json no-actions></api-example-render>
    </template>
  </test-fixture>

  <prism-highlighter></prism-highlighter>
  <script>
  suite('Basics', () => {
    let element;
    setup((done) => {
      element = fixture('Json');
      element.example = {
        value: ''
      };
      flush(() => done());
    });

    test('Clears output when no code', () => {
      const output = element.shadowRoot.querySelector('#output');
      output.innerHTML = 'test';
      Polymer.RenderStatus.afterNextRender(element, () => {
        assert.notEqual(output.innerHTML, 'test');
      });
    });

    test('Calls highlight() when code change', (done) => {
      element.example = {
        value: 'test'
      };
      const spy = sinon.spy(element, 'highlight');
      Polymer.RenderStatus.afterNextRender(element, () => {
        assert.isTrue(spy.called);
        done();
      });
    });
  });

  suite('highlight()', () => {
    let element;
    setup(() => {
      element = fixture('Basic');
    });

    test('Dispatches syntax-highlight event', () => {
      const spy = sinon.spy();
      element.addEventListener('syntax-highlight', spy);
      element.highlight('{}', 'application/json');
      assert.isTrue(spy.called);
    });

    test('Event has "code" property', () => {
      const spy = sinon.spy();
      element.addEventListener('syntax-highlight', spy);
      element.highlight('{}', 'application/json');
      const e = spy.args[0][0];
      assert.typeOf(e.detail.code, 'string');
    });

    test('Event has "lang" property set to json', () => {
      const spy = sinon.spy();
      element.addEventListener('syntax-highlight', spy);
      element.highlight('{}', 'application/json');
      const e = spy.args[0][0];
      assert.equal(e.detail.lang, 'json');
    });

    test('Event has "lang" property set to xml', () => {
      const spy = sinon.spy();
      element.addEventListener('syntax-highlight', spy);
      element.highlight('{}', 'application/xml');
      const e = spy.args[0][0];
      assert.equal(e.detail.lang, 'xml');
    });

    test('Event has no "lang" property', () => {
      const spy = sinon.spy();
      element.addEventListener('syntax-highlight', spy);
      element.highlight('{}', 'application/other');
      const e = spy.args[0][0];
      assert.isUndefined(e.detail.lang);
    });

    test('Returns parsed code', () => {
      const result = element.highlight('{}', 'application/json');
      assert.equal(result, '<span class="token punctuation">{</span><span class="token punctuation">}</span>');
    });
  });

  function clearTableStorage() {
    localStorage.removeItem('jsonTableEnabled');
  }

  suite('_toggleTable()', () => {
    let element;
    setup((done) => {
      clearTableStorage();
      element = fixture('Json');
      element.example = {
        value: '{}',
        hasTitle: false
      };
      flush(() => done());
    });

    test('Toggles "table" property', () => {
      const button = element.shadowRoot.querySelector('[data-action="table"]');
      button.click();
      assert.isTrue(element.table);
    });

    test('Deactivates sourceOpened', () => {
      element.sourceOpened = true;
      const button = element.shadowRoot.querySelector('[data-action="table"]');
      button.click();
      assert.isFalse(element.sourceOpened);
    });
  });

  suite('_toggleSourceOpened()', () => {
    let element;
    setup((done) => {
      clearTableStorage();
      element = fixture('Json');
      element.example = {
        value: '{}',
        hasTitle: false,
        hasRaw: true,
        raw: 'test'
      };
      flush(() => done());
    });

    test('Toggles "sourceOpened" property', () => {
      const button = element.shadowRoot.querySelector('[data-action="code"]');
      button.click();
      assert.isTrue(element.sourceOpened);
    });

    test('Deactivates table', () => {
      element.table = true;
      const button = element.shadowRoot.querySelector('[data-action="code"]');
      button.click();
      assert.isFalse(element.table);
    });
  });

  suite('_computeUnions', () => {
    let example;
    let element;
    setup(() => {
      element = fixture('Basic');
      example = {
        hasUnion: true,
        values: [{
          hasTitle: true,
          title: 'test-title'
        }]
      };
    });

    test('Returns undefined when not isUnion', () => {
      const result = element._computeUnions(false, example);
      assert.isUndefined(result);
    });

    test('Returns undefined when no example', () => {
      const result = element._computeUnions(true);
      assert.isUndefined(result);
    });

    test('Returns undefined when no example.values', () => {
      delete example.values;
      const result = element._computeUnions(true, example);
      assert.isUndefined(result);
    });

    test('Returns array of titles', () => {
      const result = element._computeUnions(true, example);
      assert.deepEqual(result, ['test-title']);
    });
  });

  suite('_computeRenderTitle()', () => {
    let element;
    setup(() => {
      element = fixture('Basic');
    });

    test('Returns false when no hasTitle', () => {
      const result = element._computeRenderTitle(false, false);
      assert.isFalse(result);
    });

    test('Returns false when noTitle is set', () => {
      const result = element._computeRenderTitle(true, true);
      assert.isFalse(result);
    });

    test('Returns true when no noTitle and hasTitle', () => {
      const result = element._computeRenderTitle(true, false);
      assert.isTrue(result);
    });
  });

  suite('_unionTypesChanged()', () => {
    let element;
    setup(() => {
      element = fixture('Basic');
    });

    test('Does nothing when no argument', () => {
      element.selectedUnion = 1;
      element._unionTypesChanged();
      assert.equal(element.selectedUnion, 1);
    });

    test('Re-sets selected union index', () => {
      element.selectedUnion = 1;
      element._unionTypesChanged([]);
      assert.equal(element.selectedUnion, 0);
    });
  });

  suite('_unionTypeActive()', () => {
    let element;
    setup(() => {
      element = fixture('Basic');
    });
    test('Returns false when index does not match', () => {
      const result = element._unionTypeActive(1, 2);
      assert.isFalse(result);
    });
    test('Returns true when index matches', () => {
      const result = element._unionTypeActive(1, 1);
      assert.isTrue(result);
    });
  });

  suite('_selectUnion()', () => {
    let element;
    setup((done) => {
      element = fixture('Basic');
      element.example = {
        hasUnion: true,
        values: [{
          hasTitle: true,
          title: 'test-title',
          value: 'a'
        }, {
          hasTitle: true,
          title: 'other-title',
          value: 'b'
        }]
      };
      Polymer.RenderStatus.afterNextRender(element, () => {
        flush(() => done());
      });
    });

    test('selectedUnion is 0', () => {
      assert.equal(element.selectedUnion, 0);
    });

    test('unions is computed', () => {
      assert.typeOf(element.unions, 'array');
    });

    test('Sets event target as active when selecting current selection', (done) => {
      flush(() => {
        const nodes = element.shadowRoot.querySelectorAll('.union-type-selector .union-toggle');
        nodes[0].active = false;
        MockInteractions.tap(nodes[0]);
        assert.isTrue(nodes[0].active);
        done();
      });
    });

    test('Changes the selection', (done) => {
      flush(() => {
        const nodes = element.shadowRoot.querySelectorAll('.union-type-selector .union-toggle');
        MockInteractions.tap(nodes[1]);
        assert.equal(element.selectedUnion, 1);
        done();
      });
    });
  });

  suite('_copyToClipboard()', () => {
    let element;
    setup((done) => {
      element = fixture('Basic');
      flush(() => {
        Polymer.RenderStatus.afterNextRender(element, () => done());
      });
    });

    test('Calls copy() in the `clipboard-copy` element', (done) => {
      element.example = {
        value: '{}',
        hasTitle: false
      };
      flush(() => {
        const copy = element.shadowRoot.querySelector('clipboard-copy');
        const spy = sinon.spy(copy, 'copy');
        const button = element.shadowRoot.querySelector('[data-action="copy"]');
        button.click();
        assert.isTrue(spy.called);
        done();
      });
    });

    test('Changes the icon', (done) => {
      element.example = {
        value: '{}',
        hasTitle: false
      };
      flush(() => {
        const button = element.shadowRoot.querySelector('[data-action="copy"]');
        button.click();
        assert.notEqual(button.icon, 'arc:content-copy');
        done();
      });
    });

    test('Changes icon back', (done) => {
      element.example = {
        value: '{}',
        hasTitle: false
      };
      flush(() => {
        const button = element.shadowRoot.querySelector('[data-action="copy"]');
        button.click();
        setTimeout(() => {
          assert.equal(button.icon, 'arc:content-copy');
          done();
        }, 1001);
      });
    });
  });

  suite('_resetCopyButtonState()', () => {
    let element;
    setup((done) => {
      element = fixture('Json');
      element.example = {
        value: '{}',
        hasTitle: false
      };
      flush(() => done());
    });

    test('Resets the button', () => {
      const button = element.shadowRoot.querySelector('[data-action="copy"]');
      button.icon = 'test';
      element._resetCopyButtonState(button);
      assert.equal(button.icon, 'arc:content-copy');
    });
  });

  suite('_computeIsJson()', () => {
    let element;
    setup(() => {
      element = fixture('Basic');
    });

    test('Returns false when isJson is false', () => {
      const result = element._computeIsJson(false, '{}');
      assert.isFalse(result);
    });

    test('Returns false when not no value', () => {
      const result = element._computeIsJson(true, '');
      assert.isFalse(result);
    });

    test('Returns false when invalid value', () => {
      const result = element._computeIsJson(true, '{"test"}');
      assert.isFalse(result);
    });

    test('Returns true when object', () => {
      const result = element._computeIsJson(true, '{"test": true}');
      assert.isTrue(result);
    });

    test('Returns true when array', () => {
      const result = element._computeIsJson(true, '[{"test": true}]');
      assert.isTrue(result);
    });
  });

  suite('_computeHasRaw()', () => {
    let element;
    setup(() => {
      element = fixture('Basic');
    });

    test('Returns false when no raw value', () => {
      const result = element._computeHasRaw('a');
      assert.isFalse(result);
    });

    test('Returns false when values are the same', () => {
      const result = element._computeHasRaw('a', 'a');
      assert.isFalse(result);
    });

    test('Returns true when values are not the same', () => {
      const result = element._computeHasRaw('a', 'b');
      assert.isTrue(result);
    });
  });

  suite('Actions rendering', () => {
    test('Renders actions bar', (done) => {
      const element = fixture('Json');
      element.example = {
        value: ''
      };
      flush(() => {
        const node = element.shadowRoot.querySelector('.example-actions');
        assert.ok(node);
        done();
      });
    });

    test('Actions are not rendered when no-actions is set', (done) => {
      const element = fixture('NoActions');
      element.example = {
        value: ''
      };
      flush(() => {
        const node = element.shadowRoot.querySelector('.example-actions');
        assert.notOk(node);
        done();
      });
    });
  });
  </script>
</body>
</html>
